<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat Masivo - Sistema Unificado</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); 
            min-height: 100vh; 
            padding: 20px;
        }
        .container { 
            max-width: 1400px; 
            margin: 0 auto; 
            background: white; 
            border-radius: 20px; 
            box-shadow: 0 20px 40px rgba(0,0,0,0.1); 
            overflow: hidden; 
        }
        .header { 
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); 
            color: white; 
            padding: 30px; 
            text-align: center; 
        }
        .header h1 { font-size: 2.5em; margin-bottom: 10px; }
        .header p { font-size: 1.1em; opacity: 0.9; }
        
        .nav-buttons {
            background: #f8f9fa;
            padding: 15px 30px;
            border-bottom: 1px solid #e9ecef;
            display: flex;
            gap: 15px;
        }
        
        .nav-btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            background: #6c757d;
            color: white;
            text-decoration: none;
            font-size: 0.9em;
            transition: all 0.3s ease;
        }
        
        .nav-btn:hover {
            background: #4facfe;
            transform: translateY(-2px);
        }
        
        .nav-btn.active {
            background: #4facfe;
        }
        
        .tabs { 
            display: flex; 
            margin-bottom: 30px; 
            border-bottom: 2px solid #e9ecef; 
        }
        .tab { 
            padding: 15px 30px; 
            cursor: pointer; 
            border: none; 
            background: none; 
            font-size: 1.1em; 
            color: #6c757d; 
            border-bottom: 3px solid transparent; 
            transition: all 0.3s ease; 
        }
        .tab.active { 
            color: #4facfe; 
            border-bottom-color: #4facfe; 
        }
        .tab-content { 
            display: none; 
            padding: 30px; 
        }
        .tab-content.active { 
            display: block; 
        }
        
        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; margin-bottom: 8px; font-weight: 600; color: #333; }
        .form-control { 
            width: 100%; 
            padding: 12px 15px; 
            border: 2px solid #e9ecef; 
            border-radius: 10px; 
            font-size: 1em; 
            transition: border-color 0.3s ease; 
        }
        .form-control:focus { outline: none; border-color: #4facfe; }
        
        .btn { 
            padding: 12px 25px; 
            border: none; 
            border-radius: 10px; 
            font-size: 1em; 
            cursor: pointer; 
            transition: all 0.3s ease; 
            display: inline-flex; 
            align-items: center; 
            gap: 8px; 
        }
        .btn-primary { 
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); 
            color: white; 
        }
        .btn-primary:hover { 
            transform: translateY(-2px); 
            box-shadow: 0 5px 15px rgba(79, 172, 254, 0.4); 
        }
        .btn-success { 
            background: linear-gradient(135deg, #51cf66 0%, #40c057 100%); 
            color: white; 
        }
        .btn-danger { 
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a52 100%); 
            color: white; 
        }
        .btn-warning {
            background: linear-gradient(135deg, #ffd43b 0%, #fab005 100%);
            color: white;
        }
        .btn-info {
            background: linear-gradient(135deg, #74c0fc 0%, #339af0 100%);
            color: white;
        }
        
        .grid { 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); 
            gap: 20px; 
        }
        .card { 
            background: #f8f9fa; 
            padding: 20px; 
            border-radius: 10px; 
            border: 1px solid #e9ecef; 
        }
        
        .stats-grid { 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); 
            gap: 15px; 
            margin-bottom: 20px; 
        }
        .stat-card { 
            background: #f8f9fa; 
            padding: 20px; 
            border-radius: 8px; 
            text-align: center; 
            border-left: 4px solid #4facfe; 
        }
        .stat-card h4 { 
            font-size: 2em; 
            margin: 0; 
            color: #4facfe; 
        }
        .stat-card p { 
            margin: 5px 0 0 0; 
            color: #666; 
        }
        
        table { 
            width: 100%; 
            border-collapse: collapse; 
            margin-top: 15px; 
        }
        th, td { 
            padding: 10px; 
            text-align: left; 
            border-bottom: 1px solid #ddd; 
        }
        th { 
            background-color: #f8f9fa; 
        }
        
        .alert { 
            padding: 15px 20px; 
            border-radius: 10px; 
            margin-bottom: 20px; 
        }
        .alert-success { 
            background: #d4edda; 
            color: #155724; 
            border: 1px solid #c3e6cb; 
        }
        .alert-danger { 
            background: #f8d7da; 
            color: #721c24; 
            border: 1px solid #f5c6cb; 
        }
        
        .message-preview {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
            font-family: monospace;
            white-space: pre-wrap;
        }
        
        .contact-actions {
            display: flex;
            gap: 5px;
        }
        
        .btn-sm {
            padding: 5px 10px;
            font-size: 0.8em;
        }
        
        .chatbot-tab {
            background: #28a745 !important;
            color: white !important;
            border-radius: 8px !important;
            margin-left: 10px !important;
            font-weight: bold !important;
        }
        
        .chatbot-tab:hover {
            background: #218838 !important;
            transform: translateY(-2px) !important;
            box-shadow: 0 4px 8px rgba(40, 167, 69, 0.3) !important;
        }
        
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <div>
                    <h1><i class="fas fa-users"></i> Chat Masivo</h1>
                    <p>Sistema de mensajería masiva con gestión de contactos</p>
                </div>
                <div style="text-align: right;">
                    <div id="userInfo" style="margin-bottom: 10px; font-size: 14px; opacity: 0.9;">
                        <div id="userName">Usuario</div>
                        <div id="userRole" style="font-size: 12px;">Rol</div>
                    </div>
                    <button onclick="logout()" style="background: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.3); color: white; padding: 8px 16px; border-radius: 20px; cursor: pointer; font-size: 12px;">
                        <i class="fas fa-sign-out-alt"></i> Cerrar Sesión
                    </button>
                </div>
            </div>
        </div>

        <div class="nav-buttons">
            <a href="/" class="nav-btn">
                <i class="fas fa-home"></i> Inicio
            </a>
            <a href="/chatbot" class="nav-btn">
                <i class="fas fa-robot"></i> Chatbot
            </a>
        </div>

        <div class="tabs">
            <button class="tab active" onclick="showTab('contacts-tab')">
                <i class="fas fa-users"></i> Contactos
            </button>
            <button class="tab" onclick="showTab('messages-tab')">
                <i class="fas fa-paper-plane"></i> Mensajes
            </button>
            <button class="tab" onclick="showTab('groups-tab')">
                <i class="fas fa-layer-group"></i> Grupos
            </button>
            <button class="tab chatbot-tab" onclick="redirectToChatbot()">
                <i class="fas fa-robot"></i> Ir al Chatbot
            </button>
        </div>

        <!-- Mensajes flash -->
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, message in messages %}
                    <div class="alert alert-{{ 'success' if category == 'success' else 'danger' }}">
                        {{ message }}
                    </div>
                {% endfor %}
            {% endif %}
        {% endwith %}

        <!-- Tab Contactos -->
        <div id="contacts-tab" class="tab-content active">
            <div class="grid">
                <div class="card">
                    <h3><i class="fas fa-user-plus"></i> Agregar Contacto</h3>
                    <form method="POST" action="/add_contact">
                        <div class="form-group">
                            <label for="nombre">Nombre:</label>
                            <input type="text" id="nombre" name="nombre" class="form-control" required>
                        </div>
                        <div class="form-group">
                            <label for="apellido">Apellido:</label>
                            <input type="text" id="apellido" name="apellido" class="form-control">
                        </div>
                        <div class="form-group">
                            <label for="telefono">Teléfono:</label>
                            <input type="text" id="telefono" name="telefono" class="form-control" required>
                        </div>
                        <div class="form-group">
                            <label for="carrera">Carrera:</label>
                            <input type="text" id="carrera" name="carrera" class="form-control">
                        </div>
                        <div class="form-group">
                            <label for="grupo">Grupo:</label>
                            <select id="grupo" name="grupo" class="form-control">
                                {% for grupo in grupos %}
                                <option value="{{ grupo[1] }}">{{ grupo[1] }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-plus"></i> Agregar Contacto
                        </button>
                    </form>
                </div>

                <div class="card">
                    <h3><i class="fas fa-users"></i> Lista de Contactos ({{ contactos|length }})</h3>
                    {% if contactos %}
                        <div style="max-height: 400px; overflow-y: auto;">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Nombre</th>
                                        <th>Teléfono</th>
                                        <th>Carrera</th>
                                        <th>Grupo</th>
                                        <th>Acciones</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for contacto in contactos %}
                                    <tr>
                                        <td>{{ contacto[1] }} {{ contacto[2] or '' }}</td>
                                        <td>{{ contacto[3] }}</td>
                                        <td>{{ contacto[4] or '-' }}</td>
                                        <td>{{ contacto[5] or 'General' }}</td>
                                        <td>
                                            <div class="contact-actions">
                                                <button class="btn btn-danger btn-sm" onclick="deleteContact({{ contacto[0] }})">
                                                    <i class="fas fa-trash"></i>
                                                </button>
                                            </div>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    {% else %}
                        <p>No hay contactos registrados.</p>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Tab Mensajes -->
        <div id="messages-tab" class="tab-content">
            <div class="card">
                <h3><i class="fas fa-paper-plane"></i> Envío de Mensajes Masivos</h3>
                <form method="POST" action="/send_mass_messages" id="message-form">
                    <div class="form-group">
                        <label for="grupo">Grupo:</label>
                        <select id="grupo" name="grupo" class="form-control">
                            <option value="">Todos los contactos</option>
                            {% for grupo in grupos %}
                            <option value="{{ grupo[1] }}">{{ grupo[1] }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="mensaje">Mensaje Base:</label>
                        <textarea id="mensaje" name="mensaje" class="form-control" rows="4" placeholder="Escribe tu mensaje aquí. El chatbot lo personalizará automáticamente para cada contacto." required></textarea>
                    </div>
                    
                    <div class="message-preview" id="message-preview" style="display: none;">
                        <strong>Vista previa del mensaje:</strong>
                        <div id="preview-content"></div>
                    </div>
                    
                    <div style="display: flex; gap: 10px; margin-top: 15px;">
                        <button type="button" class="btn btn-info" onclick="previewMessage()">
                            <i class="fas fa-eye"></i> Vista Previa
                        </button>
                        <button type="submit" class="btn btn-success">
                            <i class="fas fa-paper-plane"></i> Enviar Mensajes Masivos
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Tab Grupos -->
        <div id="groups-tab" class="tab-content">
            <div class="stats-grid">
                <div class="stat-card">
                    <h4>{{ stats.total_grupos }}</h4>
                    <p>Grupos Activos</p>
                </div>
                <div class="stat-card">
                    <h4>{{ stats.total_contactos }}</h4>
                    <p>Total Contactos</p>
                </div>
                <div class="stat-card">
                    <h4 id="avg-per-group">-</h4>
                    <p>Promedio por Grupo</p>
                </div>
            </div>
            
            <div class="card">
                <h3><i class="fas fa-layer-group"></i> Grupos Disponibles</h3>
                <div class="grid">
                    {% for grupo in grupos %}
                    <div class="card">
                        <h4>{{ grupo[1] }}</h4>
                        <p>{{ grupo[2] or 'Sin descripción' }}</p>
                        <small>ID: {{ grupo[0] }}</small>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>

    </div>

    <script>
        function showTab(tabId) {
            // Ocultar todos los tabs
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });

            // Mostrar tab seleccionado
            document.getElementById(tabId).classList.add('active');
            event.target.classList.add('active');
        }

        function deleteContact(id) {
            if (confirm('¿Estás seguro de que quieres eliminar este contacto?')) {
                window.location.href = '/delete_contact/' + id;
            }
        }

        function previewMessage() {
            const mensaje = document.getElementById('mensaje').value;
            const preview = document.getElementById('message-preview');
            const content = document.getElementById('preview-content');
            
            if (mensaje.trim()) {
                // Simular personalización del chatbot
                const personalizedMessage = `Hola [NOMBRE],\n\n${mensaje}\n\n¡Gracias por tu atención!`;
                content.textContent = personalizedMessage;
                preview.style.display = 'block';
            } else {
                alert('Por favor escribe un mensaje primero');
            }
        }

        function redirectToChatbot() {
            // Redirigir al chatbot principal
            try {
                window.open('/chatbot', '_blank');
            } catch (error) {
                // Fallback si no se puede abrir en nueva pestaña
                window.location.href = '/chatbot';
            }
        }

        // Calcular promedio por grupo
        function calculateAveragePerGroup() {
            const totalContacts = {{ stats.total_contactos }};
            const totalGroups = {{ stats.total_grupos }};
            const average = totalGroups > 0 ? Math.round(totalContacts / totalGroups) : 0;
            document.getElementById('avg-per-group').textContent = average;
        }

        // Inicializar al cargar la página
        document.addEventListener('DOMContentLoaded', function() {
            calculateAveragePerGroup();
            loadUserInfo();
        });

        // Función para cargar información del usuario
        async function loadUserInfo() {
            try {
                const response = await fetch('/api/auth/check');
                const result = await response.json();
                
                if (result.authenticated) {
                    document.getElementById('userName').textContent = `${result.user.name} ${result.user.lastname}`;
                    document.getElementById('userRole').textContent = result.user.role.toUpperCase();
                } else {
                    // Si no está autenticado, redirigir al login
                    window.location.href = '/login';
                }
            } catch (error) {
                console.error('Error cargando información del usuario:', error);
                window.location.href = '/login';
            }
        }

        // Función para cerrar sesión
        async function logout() {
            try {
                const response = await fetch('/api/auth/logout', { method: 'POST' });
                const result = await response.json();
                
                if (result.success) {
                    window.location.href = '/login';
                } else {
                    alert('Error al cerrar sesión: ' + result.message);
                }
            } catch (error) {
                console.error('Error cerrando sesión:', error);
                window.location.href = '/login';
            }
        }
    </script>
</body>
</html>
