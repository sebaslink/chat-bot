<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat Masivo WhatsApp</title>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            margin: 20px; 
            background-image: url('/static/uploads/ucfondo.jpg');
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
            background-repeat: no-repeat;
        }
        .container { 
            max-width: 1200px; 
            margin: 0 auto; 
            background: white; 
            padding: 20px; 
            border-radius: 10px; 
            box-shadow: 0 2px 10px rgba(0,0,0,0.1); 
        }
        .header { 
            text-align: center; 
            color: #25D366; 
            margin-bottom: 30px; 
        }
        .section { 
            margin-bottom: 30px; 
            padding: 20px; 
            border: 1px solid #ddd; 
            border-radius: 8px; 
        }
        .form-group { 
            margin-bottom: 15px; 
        }
        label { 
            display: block; 
            margin-bottom: 5px; 
            font-weight: bold; 
        }
        input, textarea, select { 
            width: 100%; 
            padding: 8px; 
            border: 1px solid #ddd; 
            border-radius: 4px; 
            box-sizing: border-box;
        }
        button { 
            background-color: #25D366; 
            color: white; 
            padding: 10px 20px; 
            border: none; 
            border-radius: 4px; 
            cursor: pointer; 
            margin-right: 10px; 
            margin-bottom: 5px; 
        }
        button:hover { 
            background-color: #128C7E; 
        }
        .btn-danger { 
            background-color: #dc3545; 
        }
        .btn-danger:hover { 
            background-color: #c82333; 
        }
        .btn-info { 
            background-color: #17a2b8; 
        }
        .btn-info:hover { 
            background-color: #138496; 
        }
        table { 
            width: 100%; 
            border-collapse: collapse; 
            margin-top: 15px; 
        }
        th, td { 
            padding: 10px; 
            text-align: left; 
            border-bottom: 1px solid #ddd; 
        }
        th { 
            background-color: #f8f9fa; 
        }
        .alert { 
            padding: 10px; 
            margin-bottom: 15px; 
            border-radius: 4px; 
        }
        .alert-success { 
            background-color: #d4edda; 
            color: #155724; 
            border: 1px solid #c3e6cb; 
        }
        .alert-error { 
            background-color: #f8d7da; 
            color: #721c24; 
            border: 1px solid #f5c6cb; 
        }
        .alert-info { 
            background-color: #d1ecf1; 
            color: #0c5460; 
            border: 1px solid #bee5eb; 
        }
        .numero-prueba { 
            background-color: #e3f2fd; 
            padding: 15px; 
            border-radius: 8px; 
            margin-bottom: 20px; 
        }
        .stats-grid { 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); 
            gap: 15px; 
            margin-bottom: 20px; 
        }
        .stat-card { 
            background: #f8f9fa; 
            padding: 20px; 
            border-radius: 8px; 
            text-align: center; 
            border-left: 4px solid #25D366; 
        }
        .stat-card h4 { 
            font-size: 2em; 
            margin: 0; 
            color: #25D366; 
        }
        .stat-card p { 
            margin: 5px 0 0 0; 
            color: #666; 
        }
        .form-row { 
            display: flex; 
            gap: 15px; 
        }
        .form-row .form-group { 
            flex: 1; 
        }
        
        /* Estilos para bot√≥n de redirecci√≥n al chatbot */
        .chatbot-redirect {
            text-align: center;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 8px;
            border-left: 4px solid #25D366;
        }
        
        .chatbot-redirect button {
            background: #25D366;
            color: white;
            padding: 15px 30px;
            border: none;
            border-radius: 8px;
            font-size: 1.1em;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .chatbot-redirect button:hover {
            background: #128C7E;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(37, 211, 102, 0.3);
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1><img src="/static/uploads/icono.jpg" alt="Icono" style="width: 50px; height: 50px; vertical-align: middle; margin-right: 15px; border-radius: 8px;">üöÄ Chat Masivo WhatsApp</h1>
            <p>Sistema de env√≠o masivo con Twilio</p>
        </div>

        <!-- Panel de Estad√≠sticas -->
        <div class="section">
            <h3>üìä Estad√≠sticas del Sistema</h3>
            <div class="stats-grid">
                <div class="stat-card">
                    <h4 id="total-contactos">{{ estadisticas.total_contactos }}</h4>
                    <p>Contactos Activos</p>
                </div>
                <div class="stat-card">
                    <h4 id="mensajes-hoy">{{ estadisticas.mensajes_hoy }}</h4>
                    <p>Mensajes Hoy</p>
                </div>
                <div class="stat-card">
                    <h4 id="mensajes-semana">{{ estadisticas.mensajes_semana }}</h4>
                    <p>Esta Semana</p>
                </div>
                <div class="stat-card">
                    <h4 id="errores-recientes">{{ estadisticas.errores_recientes }}</h4>
                    <p>Errores Recientes</p>
                </div>
            </div>
        </div>

        <!-- Bot√≥n de Redirecci√≥n al Chatbot -->
        <div class="section">
            <h3>ü§ñ Acceso al Chatbot Principal</h3>
            <div class="chatbot-redirect">
                <p style="margin-bottom: 15px; color: #495057; font-size: 1.1em;">
                    Para acceder al chatbot principal con todas sus funcionalidades avanzadas:
                </p>
                <button onclick="redirectToChatbot()">
                    üöÄ Ir al Chatbot Principal
                </button>
                <p style="margin-top: 15px; color: #666; font-size: 0.9em;">
                    Se abrir√° en una nueva pesta√±a
                </p>
            </div>
        </div>

        <!-- N√∫mero de prueba -->
        <div class="numero-prueba">
            <h3>üîß N√∫mero de Prueba</h3>
            <p><strong>N√∫mero:</strong> {{ numero_prueba }}</p>
            <button onclick="enviarPrueba()" class="btn-info">Enviar Mensaje de Prueba</button>
        </div>

        <!-- Mensajes flash -->
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, message in messages %}
                    <div class="alert alert-{{ 'success' if category == 'success' else 'error' if category == 'error' else 'info' }}">
                        {{ message }}
                    </div>
                {% endfor %}
            {% endif %}
        {% endwith %}

        <!-- Agregar nuevo n√∫mero -->
        <div class="section">
            <h3>‚ûï Agregar Nuevo Contacto</h3>
            <form method="POST" action="/agregar">
                <div class="form-row">
                    <div class="form-group">
                        <label for="nombre">Nombre:</label>
                        <input type="text" id="nombre" name="nombre" required>
                    </div>
                    <div class="form-group">
                        <label for="apellido">Apellido:</label>
                        <input type="text" id="apellido" name="apellido">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="telefono">Tel√©fono (solo n√∫meros):</label>
                        <input type="text" id="telefono" name="telefono" placeholder="51987654321" required>
                    </div>
                    <div class="form-group">
                        <label for="carrera">Carrera:</label>
                        <input type="text" id="carrera" name="carrera" placeholder="Ingenier√≠a, Medicina, etc.">
                    </div>
                </div>
                <div class="form-group">
                    <label for="grupo_id">Grupo (opcional):</label>
                    <select id="grupo_id" name="grupo_id">
                        <option value="">Seleccionar grupo</option>
                        {% for grupo in grupos %}
                        <option value="{{ grupo[0] }}">{{ grupo[1] }}</option>
                        {% endfor %}
                    </select>
                </div>
                <button type="submit">Agregar Contacto</button>
            </form>
        </div>

        <!-- Importar desde Excel -->
        <div class="section">
            <h3>üìä Importar Contactos desde Excel</h3>
            <div style="margin-bottom: 15px;">
                <a href="/descargar_plantilla_excel" class="btn-info" style="text-decoration: none; display: inline-block;">üì• Descargar Plantilla Excel</a>
            </div>
            <form method="POST" action="/importar_excel" enctype="multipart/form-data">
                <div class="form-group">
                    <label for="archivo_excel">Seleccionar archivo Excel (.xlsx):</label>
                    <input type="file" id="archivo_excel" name="archivo_excel" accept=".xlsx,.xls" required>
                </div>
                <div class="form-group">
                    <label for="grupo_importar">Grupo para los contactos (opcional):</label>
                    <select id="grupo_importar" name="grupo_importar">
                        <option value="">Sin grupo</option>
                        {% for grupo in grupos %}
                        <option value="{{ grupo[0] }}">{{ grupo[1] }}</option>
                        {% endfor %}
                    </select>
                </div>
                <button type="submit" style="background-color: #28a745;">üì§ Importar Contactos</button>
            </form>
            <div style="margin-top: 15px; padding: 10px; background-color: #e9ecef; border-radius: 5px;">
                <h5>üìã Formato requerido del Excel:</h5>
                <ul style="margin: 5px 0; padding-left: 20px;">
                    <li><strong>nombre</strong> - Nombre del contacto (obligatorio)</li>
                    <li><strong>apellido</strong> - Apellido del contacto</li>
                    <li><strong>numero</strong> - N√∫mero de tel√©fono (obligatorio)</li>
                    <li><strong>carrera</strong> - Carrera o profesi√≥n</li>
                </ul>
                <p style="margin: 5px 0; font-size: 0.9em; color: #666;">
                    üí° <strong>Tip:</strong> Descarga la plantilla para ver el formato exacto
                </p>
            </div>
        </div>

        <!-- Lista de n√∫meros -->
        <div class="section">
            <h3>üìã Contactos Registrados ({{ numeros|length }}/5000)</h3>
            <div style="margin-bottom: 15px;">
                <a href="/exportar_contactos" class="btn-info" style="text-decoration: none; display: inline-block;">üì• Exportar CSV</a>
                <button onclick="eliminarTodos()" class="btn-danger" style="margin-left: 10px;">üóëÔ∏è Eliminar Todos los Contactos</button>
            </div>
            
            <!-- Barra de progreso del l√≠mite -->
            <div style="margin-bottom: 15px;">
                <div style="background-color: #e9ecef; border-radius: 10px; height: 20px; overflow: hidden;">
                    <div style="background-color: {{ '#28a745' if numeros|length < 4000 else '#ffc107' if numeros|length < 4500 else '#dc3545' }}; height: 100%; width: {{ (numeros|length / 5000 * 100)|round(1) }}%; transition: width 0.3s ease;"></div>
                </div>
                <div style="text-align: center; margin-top: 5px; font-size: 0.9em; color: #666;">
                    {{ numeros|length }} / 5000 contactos ({{ (numeros|length / 5000 * 100)|round(1) }}%)
                </div>
                
                <!-- Advertencias de l√≠mite -->
                {% if numeros|length >= 4500 %}
                    <div style="background-color: #f8d7da; color: #721c24; padding: 10px; border-radius: 5px; margin-top: 10px; border: 1px solid #f5c6cb;">
                        <strong>‚ö†Ô∏è Advertencia:</strong> Te acercas al l√≠mite de 5000 contactos. Solo puedes agregar {{ 5000 - numeros|length }} contactos m√°s.
                    </div>
                {% elif numeros|length >= 4000 %}
                    <div style="background-color: #fff3cd; color: #856404; padding: 10px; border-radius: 5px; margin-top: 10px; border: 1px solid #ffeaa7;">
                        <strong>‚ÑπÔ∏è Informaci√≥n:</strong> Has usado {{ (numeros|length / 5000 * 100)|round(1) }}% del l√≠mite de contactos.
                    </div>
                {% endif %}
            </div>
            {% if numeros %}
                <table>
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Nombre Completo</th>
                            <th>Tel√©fono</th>
                            <th>Carrera</th>
                            <th>Grupo</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for numero in numeros %}
                        <tr>
                            <td>{{ numero[0] }}</td>
                            <td>
                                <strong>{{ numero[1] }}</strong>
                                {% if numero[2] %}
                                    {{ numero[2] }}
                                {% endif %}
                            </td>
                            <td>+{{ numero[3] }}</td>
                            <td>
                                {% if numero[4] %}
                                    <span style="background: #f8f9fa; color: #495057; padding: 2px 6px; border-radius: 8px; font-size: 0.8em;">{{ numero[4] }}</span>
                                {% else %}
                                    <span style="color: #999;">-</span>
                                {% endif %}
                            </td>
                            <td>
                                {% if numero[5] %}
                                    <span style="background: #e3f2fd; color: #1976d2; padding: 2px 8px; border-radius: 12px; font-size: 0.8em;">{{ numero[5] }}</span>
                                {% else %}
                                    <span style="color: #999;">Sin grupo</span>
                                {% endif %}
                            </td>
                            <td>
                                <button onclick="desactivar({{ numero[0] }})" class="btn-warning" style="margin-right: 5px;">Desactivar</button>
                                <button onclick="eliminar({{ numero[0] }})" class="btn-danger">Eliminar</button>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            {% else %}
                <p>No hay contactos registrados.</p>
            {% endif %}
        </div>

        <!-- Env√≠o masivo -->
        <div class="section">
            <h3>üì§ Env√≠o Masivo de Mensajes</h3>
            <form method="POST" action="/enviar_masivo" enctype="multipart/form-data">
                <div class="form-group">
                    <label for="grupo_envio">Grupo (opcional):</label>
                    <select id="grupo_envio" name="grupo_id">
                        <option value="">Todos los contactos</option>
                        {% for grupo in grupos %}
                        <option value="{{ grupo[0] }}">{{ grupo[1] }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="form-group">
                    <label for="intro">Introducci√≥n:</label>
                    <input type="text" id="intro" name="intro" value="mane" required>
                </div>
                <div class="form-group">
                    <label for="texto_random">Texto Aleatorio (opcional):</label>
                    <input type="text" id="texto_random" name="texto_random" placeholder="Dejar vac√≠o para texto aleatorio autom√°tico">
                </div>
                <div class="form-group">
                    <label for="texto_fijo">Texto Predeterminado:</label>
                    <textarea id="texto_fijo" name="texto_fijo" rows="4" required>Este es el mensaje predeterminado.</textarea>
                </div>
                <div class="form-group" style="border: 2px dashed #25D366; padding: 20px; border-radius: 8px; background-color: #f8f9fa;">
                    <label for="imagen" style="font-size: 1.1em; color: #25D366; margin-bottom: 10px;">üñºÔ∏è Agregar Imagen (opcional)</label>
                    <input type="file" id="imagen" name="imagen" accept=".png,.jpg,.jpeg" onchange="previewImage(this)" style="padding: 10px; border: 2px solid #25D366; background-color: white;">
                    <small style="color: #666; font-size: 0.9em; display: block; margin-top: 8px;">
                        üìã Formatos permitidos: PNG, JPG, JPEG | üìè Tama√±o m√°ximo: 16MB
                    </small>
                    <div id="imagePreview" style="margin-top: 15px; display: none; text-align: center;">
                        <h4 style="color: #25D366; margin-bottom: 10px;">Vista Previa de la Imagen:</h4>
                        <img id="previewImg" style="max-width: 300px; max-height: 300px; border: 2px solid #25D366; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                        <br>
                        <button type="button" onclick="clearImage()" style="margin-top: 10px; padding: 8px 15px; background: #dc3545; color: white; border: none; border-radius: 5px; cursor: pointer; font-weight: bold;">
                            ‚ùå Quitar Imagen
                        </button>
                    </div>
                </div>
                <button type="submit" onclick="return confirm('¬øEnviar mensajes a todos los contactos seleccionados?')" style="background-color: #ffc107; color: #000;">
                    üöÄ Enviar Mensajes Masivos
                </button>
            </form>
        </div>
    </div>

    <script>
        function desactivar(id) {
            if (confirm('¬øDesactivar este contacto?')) {
                window.location.href = '/desactivar/' + id;
            }
        }

        function eliminar(id) {
            if (confirm('‚ö†Ô∏è ADVERTENCIA: ¬øEst√°s seguro de que quieres ELIMINAR este contacto?\n\nEsta acci√≥n NO se puede deshacer y eliminar√°:\n- El contacto de la base de datos\n- Todo el historial de mensajes de este contacto\n\n¬øContinuar?')) {
                if (confirm('üö® CONFIRMACI√ìN FINAL: ¬øRealmente quieres ELIMINAR este contacto?\n\nEsta acci√≥n es IRREVERSIBLE.')) {
                    window.location.href = '/eliminar/' + id;
                }
            }
        }

        function enviarPrueba() {
            if (confirm('¬øEnviar mensaje de prueba al n√∫mero +{{ numero_prueba }}?')) {
                fetch('/api/enviar_prueba', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert('‚úÖ Mensaje de prueba enviado exitosamente!');
                    } else {
                        alert('‚ùå Error: ' + data.message);
                    }
                })
                .catch(error => {
                    alert('‚ùå Error: ' + error);
                });
            }
        }

        function eliminarTodos() {
            if (confirm('‚ö†Ô∏è ADVERTENCIA: ¬øEst√°s seguro de que quieres eliminar TODOS los contactos?\n\nEsta acci√≥n NO se puede deshacer y eliminar√°:\n- Todos los contactos registrados\n- Todo el historial de mensajes\n\n¬øContinuar?')) {
                if (confirm('üö® CONFIRMACI√ìN FINAL: ¬øRealmente quieres eliminar TODOS los contactos?\n\nEsta acci√≥n es IRREVERSIBLE.')) {
                    // Crear formulario para enviar POST
                    const form = document.createElement('form');
                    form.method = 'POST';
                    form.action = '/eliminar_todos_contactos';
                    
                    document.body.appendChild(form);
                    form.submit();
                }
            }
        }

        // Funci√≥n para vista previa de imagen
        function previewImage(input) {
            if (input.files && input.files[0]) {
                var reader = new FileReader();
                reader.onload = function(e) {
                    document.getElementById('previewImg').src = e.target.result;
                    document.getElementById('imagePreview').style.display = 'block';
                }
                reader.readAsDataURL(input.files[0]);
            }
        }

        // Funci√≥n para quitar imagen
        function clearImage() {
            document.getElementById('imagen').value = '';
            document.getElementById('imagePreview').style.display = 'none';
        }

        // Validaci√≥n de tama√±o de archivo
        document.getElementById('imagen').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                const maxSize = 16 * 1024 * 1024; // 16MB
                if (file.size > maxSize) {
                    alert('El archivo es demasiado grande. El tama√±o m√°ximo permitido es 16MB.');
                    this.value = '';
                    clearImage();
                }
            }
        });

        // Funci√≥n para redirecci√≥n al chatbot
        function redirectToChatbot() {
            window.open('/chatbot', '_blank');
        }

        // Actualizar estad√≠sticas cada 30 segundos
        setInterval(function() {
            fetch('/api/estadisticas')
                .then(response => response.json())
                .then(data => {
                    document.getElementById('total-contactos').textContent = data.total_contactos;
                    document.getElementById('mensajes-hoy').textContent = data.mensajes_hoy;
                    document.getElementById('mensajes-semana').textContent = data.mensajes_semana;
                    document.getElementById('errores-recientes').textContent = data.errores_recientes;
                })
                .catch(error => console.log('Error actualizando estad√≠sticas:', error));
        }, 30000);

        // Inicializar p√°gina
        document.addEventListener('DOMContentLoaded', function() {
            // P√°gina lista para usar
        });
    </script>
</body>
</html>
