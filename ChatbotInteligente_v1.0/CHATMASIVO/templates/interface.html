<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat Masivo WhatsApp - Pro</title>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            margin: 20px; 
            background-image: url('/static/uploads/ucfondo.jpg');
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
            background-repeat: no-repeat;
        }
        .container { max-width: 1400px; margin: 0 auto; background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .header { text-align: center; color: #8607da; margin-bottom: 30px; }
        .section { margin-bottom: 30px; padding: 20px; border: 1px solid #ddd; border-radius: 8px; }
        .form-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; font-weight: bold; }
        input, textarea, select { width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; }
        button { background-color: #25D366; color: white; padding: 10px 20px; border: none; border-radius: 4px; cursor: pointer; margin-right: 10px; margin-bottom: 5px; }
        button:hover { background-color: #128C7E; }
        .btn-danger { background-color: #dc3545; }
        .btn-danger:hover { background-color: #c82333; }
        .btn-info { background-color: #17a2b8; }
        .btn-info:hover { background-color: #138496; }
        .btn-warning { background-color: #ffc107; color: #000; }
        .btn-warning:hover { background-color: #e0a800; }
        .btn-secondary { background-color: #6c757d; }
        .btn-secondary:hover { background-color: #545b62; }
        table { width: 100%; border-collapse: collapse; margin-top: 15px; }
        th, td { padding: 10px; text-align: left; border-bottom: 1px solid #ddd; }
        th { background-color: #f8f9fa; }
        .alert { padding: 10px; margin-bottom: 15px; border-radius: 4px; }
        .alert-success { background-color: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .alert-error { background-color: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .alert-info { background-color: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
        .numero-prueba { background-color: #e3f2fd; padding: 15px; border-radius: 8px; margin-bottom: 20px; }
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px; }
        .stat-card { background: #f8f9fa; padding: 20px; border-radius: 8px; text-align: center; border-left: 4px solid #25D366; }
        .stat-card h4 { font-size: 2em; margin: 0; color: #25D366; }
        .stat-card p { margin: 5px 0 0 0; color: #666; }
        .tabs { display: flex; margin-bottom: 20px; }
        .tab { padding: 10px 20px; background: #e9ecef; border: none; cursor: pointer; margin-right: 5px; }
        .tab.active { background: #25D366; color: white; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .form-row { display: flex; gap: 15px; }
        .form-row .form-group { flex: 1; }
        .grupo-badge { background: #e3f2fd; color: #1976d2; padding: 2px 8px; border-radius: 12px; font-size: 0.8em; }
        .plantilla-item { background: #f8f9fa; padding: 15px; margin: 10px 0; border-radius: 8px; border-left: 4px solid #25D366; }
        .plantilla-item h5 { margin: 0 0 10px 0; color: #25D366; }
        .plantilla-item p { margin: 5px 0; color: #666; font-size: 0.9em; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1><img src="/static/uploads/icono.jpg" alt="Icono" style="width: 50px; height: 50px; vertical-align: middle; margin-right: 15px; border-radius: 8px;">üöÄ Chat Masivo WhatsApp - Pro</h1>
            <p>Sistema de env√≠o masivo con Twilio - Versi√≥n Profesional</p>
        </div>

        <!-- Panel de Estad√≠sticas -->
        <div class="section">
            <h3>üìä Estad√≠sticas del Sistema</h3>
            <div class="stats-grid">
                <div class="stat-card">
                    <h4>{{ estadisticas.total_contactos }}</h4>
                    <p>Contactos Activos</p>
                </div>
                <div class="stat-card">
                    <h4>{{ estadisticas.mensajes_hoy }}</h4>
                    <p>Mensajes Hoy</p>
                </div>
                <div class="stat-card">
                    <h4>{{ estadisticas.mensajes_semana }}</h4>
                    <p>Esta Semana</p>
                </div>
                <div class="stat-card">
                    <h4>{{ estadisticas.errores_recientes }}</h4>
                    <p>Errores Recientes</p>
                </div>
            </div>
        </div>

        <!-- N√∫mero de prueba -->
        <div class="numero-prueba">
            <h3>üîß N√∫mero de Prueba</h3>
            <p><strong>N√∫mero:</strong> +{{ numero_prueba }}</p>
            <button onclick="enviarPrueba()" class="btn-info">Enviar Mensaje de Prueba</button>
        </div>

        <!-- Mensajes flash -->
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, message in messages %}
                    <div class="alert alert-{{ 'success' if category == 'success' else 'error' if category == 'error' else 'info' }}">
                        {{ message }}
                    </div>
                {% endfor %}
            {% endif %}
        {% endwith %}

        <!-- Tabs de Navegaci√≥n -->
        <div class="tabs">
            <button class="tab active" onclick="showTab('contactos')">üë• Contactos</button>
            <button class="tab" onclick="showTab('importar')">üì• Importar</button>
            <button class="tab" onclick="showTab('grupos')">üè∑Ô∏è Grupos</button>
            <button class="tab" onclick="showTab('plantillas')">üìù Plantillas</button>
            <button class="tab" onclick="showTab('envio')">üì§ Env√≠o Masivo</button>
        </div>

        <!-- Tab: Contactos -->
        <div id="contactos" class="tab-content active">
            <!-- Agregar nuevo n√∫mero -->
            <div class="section">
                <h3>‚ûï Agregar Nuevo Contacto</h3>
                <form method="POST" action="/agregar">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="nombre">Nombre:</label>
                            <input type="text" id="nombre" name="nombre" required>
                        </div>
                        <div class="form-group">
                            <label for="apellido">Apellido:</label>
                            <input type="text" id="apellido" name="apellido">
                        </div>
                        <div class="form-group">
                            <label for="telefono">Tel√©fono (solo n√∫meros):</label>
                            <input type="text" id="telefono" name="telefono" placeholder="5491122334455" required>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="carrera">Carrera:</label>
                            <input type="text" id="carrera" name="carrera" placeholder="Ingenier√≠a de Sistemas">
                        </div>
                        <div class="form-group">
                            <label for="grupo_id">Grupo:</label>
                            <select id="grupo_id" name="grupo_id">
                                <option value="">Seleccionar grupo</option>
                                {% for grupo in grupos %}
                                <option value="{{ grupo[0] }}">{{ grupo[1] }}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                    <button type="submit">Agregar Contacto</button>
                </form>
            </div>

            <!-- Lista de n√∫meros -->
            <div class="section">
                <h3>üìã Contactos Registrados ({{ numeros|length }})</h3>
                <div style="margin-bottom: 15px;">
                    <a href="/exportar_contactos" class="btn-secondary">üì• Exportar CSV</a>
                </div>
                {% if numeros %}
                    <table>
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Nombre Completo</th>
                                <th>Tel√©fono</th>
                                <th>Carrera</th>
                                <th>Grupo</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for numero in numeros %}
                            <tr>
                                <td>{{ numero[0] }}</td>
                                <td>{{ numero[1] }} {{ numero[2] or '' }}</td>
                                <td>+{{ numero[3] }}</td>
                                <td>{{ numero[4] or 'Sin carrera' }}</td>
                                <td>
                                    {% if numero[5] %}
                                        <span class="grupo-badge">{{ numero[5] }}</span>
                                    {% else %}
                                        <span style="color: #999;">Sin grupo</span>
                                    {% endif %}
                                </td>
                                <td>
                                    <button onclick="desactivar({{ numero[0] }})" class="btn-danger">Desactivar</button>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                {% else %}
                    <p>No hay contactos registrados.</p>
                {% endif %}
            </div>
        </div>

        <!-- Tab: Importar -->
        <div id="importar" class="tab-content">
            <div class="section">
                <h3>üì• Importar Contactos desde Excel</h3>
                <p>Importa contactos masivamente desde un archivo Excel. El archivo debe contener las columnas: <strong>nombre, apellido, numero, carrera, grupo</strong></p>
                
                <form method="POST" action="/importar_excel" enctype="multipart/form-data">
                    <div class="form-group">
                        <label for="archivo_excel">Seleccionar archivo Excel (.xlsx):</label>
                        <input type="file" id="archivo_excel" name="archivo_excel" accept=".xlsx,.xls" required>
                    </div>
                    <div class="form-group">
                        <label for="grupo_importar">Grupo por defecto (opcional):</label>
                        <select id="grupo_importar" name="grupo_importar">
                            <option value="">Usar grupo del Excel</option>
                            {% for grupo in grupos %}
                            <option value="{{ grupo[0] }}">{{ grupo[1] }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <button type="submit" class="btn-info">üì• Importar Contactos</button>
                </form>
            </div>

            <div class="section">
                <h3>üìã Plantilla de Excel</h3>
                <p>Descarga una plantilla de Excel con el formato correcto para importar contactos:</p>
                <a href="/descargar_plantilla_excel" class="btn-secondary">üì• Descargar Plantilla Excel</a>
            </div>
        </div>

        <!-- Tab: Grupos -->
        <div id="grupos" class="tab-content">
            <div class="section">
                <h3>üè∑Ô∏è Gesti√≥n de Grupos</h3>
                <form method="POST" action="/crear_grupo">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="grupo_nombre">Nombre del Grupo:</label>
                            <input type="text" id="grupo_nombre" name="nombre" required>
                        </div>
                        <div class="form-group">
                            <label for="grupo_descripcion">Descripci√≥n:</label>
                            <input type="text" id="grupo_descripcion" name="descripcion" placeholder="Descripci√≥n opcional">
                        </div>
                    </div>
                    <button type="submit">Crear Grupo</button>
                </form>
            </div>

            <div class="section">
                <h3>üìã Grupos Existentes</h3>
                {% if grupos %}
                    <table>
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Nombre</th>
                                <th>Descripci√≥n</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for grupo in grupos %}
                            <tr>
                                <td>{{ grupo[0] }}</td>
                                <td>{{ grupo[1] }}</td>
                                <td>{{ grupo[2] or 'Sin descripci√≥n' }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                {% else %}
                    <p>No hay grupos creados.</p>
                {% endif %}
            </div>
        </div>

        <!-- Tab: Plantillas -->
        <div id="plantillas" class="tab-content">
            <div class="section">
                <h3>üìù Crear Nueva Plantilla</h3>
                <form method="POST" action="/guardar_plantilla">
                    <div class="form-group">
                        <label for="plantilla_nombre">Nombre de la Plantilla:</label>
                        <input type="text" id="plantilla_nombre" name="nombre" required>
                    </div>
                    <div class="form-group">
                        <label for="plantilla_intro">Introducci√≥n:</label>
                        <input type="text" id="plantilla_intro" name="intro" value="mane">
                    </div>
                    <div class="form-group">
                        <label for="plantilla_random">Texto Aleatorio (opcional):</label>
                        <input type="text" id="plantilla_random" name="texto_random" placeholder="Dejar vac√≠o para texto aleatorio autom√°tico">
                    </div>
                    <div class="form-group">
                        <label for="plantilla_fijo">Texto Fijo:</label>
                        <textarea id="plantilla_fijo" name="texto_fijo" rows="3" required></textarea>
                    </div>
                    <button type="submit">Guardar Plantilla</button>
                </form>
            </div>

            <div class="section">
                <h3>üìã Plantillas Guardadas</h3>
                {% if plantillas %}
                    {% for plantilla in plantillas %}
                    <div class="plantilla-item">
                        <h5>{{ plantilla[1] }}</h5>
                        <p><strong>Intro:</strong> {{ plantilla[2] }}</p>
                        <p><strong>Aleatorio:</strong> {{ plantilla[3] or 'Autom√°tico' }}</p>
                        <p><strong>Fijo:</strong> {{ plantilla[4] }}</p>
                    </div>
                    {% endfor %}
                {% else %}
                    <p>No hay plantillas guardadas.</p>
                {% endif %}
            </div>
        </div>

        <!-- Tab: Env√≠o Masivo -->
        <div id="envio" class="tab-content">
            <div class="section">
                <h3>üì§ Env√≠o Masivo de Mensajes</h3>
                <form method="POST" action="/enviar_masivo" enctype="multipart/form-data">
                    <div class="form-group">
                        <label for="grupo_envio">Grupo (opcional):</label>
                        <select id="grupo_envio" name="grupo_id">
                            <option value="">Todos los contactos</option>
                            {% for grupo in grupos %}
                            <option value="{{ grupo[0] }}">{{ grupo[1] }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="intro">Introducci√≥n:</label>
                        <input type="text" id="intro" name="intro" value="mane" required>
                    </div>
                    <div class="form-group">
                        <label for="texto_random">Texto Aleatorio (opcional):</label>
                        <input type="text" id="texto_random" name="texto_random" placeholder="Dejar vac√≠o para texto aleatorio autom√°tico">
                    </div>
                    <div class="form-group">
                        <label for="texto_fijo">Texto Predeterminado:</label>
                        <textarea id="texto_fijo" name="texto_fijo" rows="4" required>Este es el mensaje predeterminado.</textarea>
                    </div>
                    <div class="form-group">
                        <label for="imagen">üñºÔ∏è Imagen (opcional):</label>
                        <input type="file" id="imagen" name="imagen" accept=".png,.jpg,.jpeg" onchange="previewImage(this)">
                        <small style="color: #666; font-size: 0.9em;">
                            Formatos permitidos: PNG, JPG, JPEG. Tama√±o m√°ximo: 16MB
                        </small>
                        <div id="imagePreview" style="margin-top: 10px; display: none;">
                            <img id="previewImg" style="max-width: 200px; max-height: 200px; border: 1px solid #ddd; border-radius: 4px;">
                            <br>
                            <button type="button" onclick="clearImage()" style="margin-top: 5px; padding: 5px 10px; background: #dc3545; color: white; border: none; border-radius: 3px; cursor: pointer;">
                                ‚ùå Quitar Imagen
                            </button>
                        </div>
                    </div>
                    <button type="submit" onclick="return confirm('¬øEnviar mensajes a todos los contactos seleccionados?')" class="btn-warning">
                        üöÄ Enviar Mensajes Masivos
                    </button>
                </form>
            </div>
        </div>
    </div>

    <script>
        function showTab(tabName) {
            // Ocultar todos los tabs
            var tabs = document.getElementsByClassName('tab-content');
            for (var i = 0; i < tabs.length; i++) {
                tabs[i].classList.remove('active');
            }
            
            // Desactivar todos los botones
            var buttons = document.getElementsByClassName('tab');
            for (var i = 0; i < buttons.length; i++) {
                buttons[i].classList.remove('active');
            }
            
            // Mostrar el tab seleccionado
            document.getElementById(tabName).classList.add('active');
            event.target.classList.add('active');
        }

        function desactivar(id) {
            if (confirm('¬øDesactivar este contacto?')) {
                window.location.href = '/desactivar/' + id;
            }
        }

        function enviarPrueba() {
            if (confirm('¬øEnviar mensaje de prueba al n√∫mero +{{ numero_prueba }}?')) {
                fetch('/api/enviar_prueba', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert('‚úÖ Mensaje de prueba enviado exitosamente!');
                    } else {
                        alert('‚ùå Error: ' + data.message);
                    }
                })
                .catch(error => {
                    alert('‚ùå Error: ' + error);
                });
            }
        }

        // Funci√≥n para vista previa de imagen
        function previewImage(input) {
            if (input.files && input.files[0]) {
                var reader = new FileReader();
                reader.onload = function(e) {
                    document.getElementById('previewImg').src = e.target.result;
                    document.getElementById('imagePreview').style.display = 'block';
                }
                reader.readAsDataURL(input.files[0]);
            }
        }

        // Funci√≥n para quitar imagen
        function clearImage() {
            document.getElementById('imagen').value = '';
            document.getElementById('imagePreview').style.display = 'none';
        }

        // Validaci√≥n de tama√±o de archivo
        document.getElementById('imagen').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                const maxSize = 16 * 1024 * 1024; // 16MB
                if (file.size > maxSize) {
                    alert('El archivo es demasiado grande. El tama√±o m√°ximo permitido es 16MB.');
                    this.value = '';
                    clearImage();
                }
            }
        });

        // Actualizar estad√≠sticas cada 30 segundos
        setInterval(function() {
            fetch('/api/estadisticas')
                .then(response => response.json())
                .then(data => {
                    // Actualizar las estad√≠sticas en la p√°gina
                    document.querySelector('.stat-card:nth-child(1) h4').textContent = data.total_contactos;
                    document.querySelector('.stat-card:nth-child(2) h4').textContent = data.mensajes_hoy;
                    document.querySelector('.stat-card:nth-child(3) h4').textContent = data.mensajes_semana;
                    document.querySelector('.stat-card:nth-child(4) h4').textContent = data.errores_recientes;
                })
                .catch(error => console.log('Error actualizando estad√≠sticas:', error));
        }, 30000);
    </script>
</body>
</html>